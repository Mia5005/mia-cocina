
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><title>Admin</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"></head>
<body class="container mt-4">
  <h1 class="mb-4">Panel Admin</h1>

  <h3>Menú</h3>
  <table class="table">
    <thead><tr><th>Nombre</th><th>Precio</th><th>Inventario</th><th>Imagen</th><th>Acción</th></tr></thead>
    <tbody>
      {% for m in menu %}
      <tr>
        <td><input id="nombre_{{ m.id }}" value="{{ m.nombre }}" class="form-control"></td>
        <td><input id="precio_{{ m.id }}" value="{{ m.precio }}" class="form-control" type="number"></td>
        <td><input id="inventario_{{ m.id }}" value="{{ m.inventario }}" class="form-control" type="number"></td>
        <td>
          {% if m.imagen %}
            <img src="{{ m.imagen }}" width="80" class="d-block mb-1">
          {% endif %}
          <input type="file" id="file_{{ m.id }}" class="form-control form-control-sm">
          <button class="btn btn-sm btn-outline-primary mt-1" onclick="subirImagen({{ m.id }})">Subir imagen</button>
        </td>
        <td>
          <button class="btn btn-success" onclick="guardar({{ m.id }})">Guardar</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h3>Pedidos activos</h3>
  {% for p in pedidos %}
    <div class="card mb-2"><div class="card-body">
      <h5>Mesa {{ p.mesa_id }} — ${{ p.total }}</h5>
      <ul>{% for it in p.item %}<li>{{ it.nombre }} x{{ it.cantidad }}</li>{% endfor %}</ul>
    </div></div>
  {% else %}<p>No hay pedidos</p>{% endfor %}

  <h3>Historial</h3>
  {% for h in historial %}
    <div class="card mb-2"><div class="card-body">
      <h5>Mesa {{ h.mesa_id }} — ${{ h.total }}</h5>
      <p>{{ h.timestamp }}</p>
    </div></div>
  {% else %}<p>No hay historial</p>{% endfor %}

<script>
async function guardar(id){
  const payload = {
    id: id,
    nombre: document.getElementById('nombre_'+id).value,
    precio: parseFloat(document.getElementById('precio_'+id).value),
    inventario: parseInt(document.getElementById('inventario_'+id).value)
  };
  const res = await fetch('/admin/actualizar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const data = await res.json();
  alert(data.message);
  location.reload();
}
async function subirImagen(id){
  const fileInput = document.getElementById('file_'+id);
  if(!fileInput.files.length){ alert('Selecciona archivo'); return; }
  const fd = new FormData();
  fd.append('imagen', fileInput.files[0]);
  const res = await fetch(`/admin/subir_imagen/${id}`, {method:'POST', body: fd});
  const data = await res.json();
  alert(data.message);
  location.reload();
}
</script>
</body>
</html>
